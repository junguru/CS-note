# Internetworking Protocol (IP)

## IP 개요
* 이더넷 등 서로 다른 링크 계층 네트워크 기술 간 호환성 문제 해결을 위해 고안됨
* 비연결 프로토콜로, 패킷 전송 순서와 속도 등을 관리하지 않음


<br/>
<br/>

## IP 헤더
|필드|길이(bit)|내용|
|---|:---:|---|
|Version|4|IP버전. 0b'0100|
|IHL|4|헤더의 길이|
|ToS|8||
|Total Length|16|데이터그램 전체 길이|
|Identification|16|데이터그램 분할 관련|
|Flags|3|데이터그램 분할 관련|
|Fragment Offset|13|데이터그램 분할 관련|
|Time To Live|8|데이터그램의 수명|
|Protocol|8|페이로드의 전송 계층 프로토콜|
|Header Checksum|16|헤더의 체크섬|
|Source Address|32|전송자 주소|
|Destination Address|32|목적지 주소|
|Options|||
|Padding|||

### IHL (IP Header Length)
* IP 헤더의 길이. 4바이트 단위로 나타냄
* 길이가 4비트로 0 ~ 15의 값을 가지므로 헤더의 길이는 최대 60바이트
* 고정 필드의 길이가 20바이트이므로 옵션 필드의 최대 길이는 40바이트

<br/>

### Identification
* IP 데이터그램에 부여하는 고유의 번호
* 출발지 IP, 목적지 IP 쌍마다 고유의 카운터 값을 유지함
    * 데이터그램을 전송할 때마다 1씩 증가하는 카운터
* 분할된 데이터그램이 재조립될 때 다른 데이터그램과 섞이지 않도록 식별 번호를 사용

### Flags
* `MF` : 뒤에 분할된 프래그먼트가 더 존재함을 나타내는 플래그
* `DF` : 데이터그램 분할을 금지하는 플래그
* **pMTU** (경로 MTU) 발견 시 DF 플래그를 1로 사용
    1. 목적지까지의 pMTU를 발견하기 위해 크기가 큰 데이터그램의 DF를 1로 설정해 전송
    2. 링크의 MTU가 패킷 크기보다 작은 경우 DF=1이므로 분할 불가능
    3. 데이터그램이 버려지고 호스트에게 ICMP 에러 메시지가 전송되어 링크의 MTU 알림
    4. 데이터그램 크기를 줄여나가며 1~3을 반복해 pMTU를 결정

### Fragment Offset
* 분할된 데이터그램이 이전 데이터그램에서 어느 위치에 있는지를 나타냄
* 8바이트 단위로 위치를 나타내므로, 분할 시 8의 배수 크기로 데이터그램 분할

<br/>

### Time To Live (TTL)
* 데이터그램의 수명으로, 라우터를 지날 때마다 1씩 감소
* TTL을 통해 **라우팅 루프** 발견
    * 인터넷의 직경은 30 정도로 30홉 내에 전 세계의 모든 망에 접속 가능함
    * 즉, TTL이 0이 되었다는 것은 라우팅 루프가 발생했다는 것임
    * 링크 고장 등으로 라우팅 경로 업데이트 시 일시적으로 루프 발생 가능

<br/>

### Header Checksum
* 체크섬 필드를 제외한 헤더 필드들을 16비트 단위로 1의 보수 덧셈 (2진수 덧셈) 뒤 1의 보수 취해 체크섬 값을 얻음
    * 헤더의 값의 합이 S라면 체크섬 값은 -S가 됨
* TTL의 감소, 데이터그램 분할 등의 이유로 라우터에서 매번 체크섬을 다시 계산함
* 네트워크 인터페이스 카드(NIC)에서 체크섬 계산을 대신 수행하는 체크섬 오프로드 수행 가능

<br/>
<br/>

## IP 포워딩
### 라우팅 vs 포워딩
* 라우팅
    * IP 주소를 기반으로 라우터들이 어떤 경로로 데이터그램을 전송해야 하는지 지도(라우팅 테이블)를 작성
    * BGP, OSPF 등 프로토콜 통해 라우팅 테이블을 구성
* 포워딩
    * 만들어진 라우팅 테이블을 참조해 목적지 IP 주소에서 다음 홉의 IP 주소와 나가야 할 인터페이스 결정

<br/>

### 라우팅 테이블
* 목적지 네트워크
* 네트워크 마스크
* 인터페이스
* 다음 홉 IP 주소 (게이트웨이)
* 엔트리 우선순위 (메트릭)

<br/>

### 포워딩 과정
1. 데이터그램의 목적지 IP 주소와 엔트리의 네트워크 마스크를 AND해 엔트리의 목적지와 일치하는지 비교
2. 일치하는 라우팅 테이블 엔트리 중 프리픽스가 가장 긴 엔트리 선택
3. 만약 가장 긴 프리픽스 엔트리가 여러개라면 메트릭 값이 작은 엔트리를 선택
4. 엔트리의 필드에서 나가야 할 인터페이스와 다음 홉의 IP 주소를 알 수 있음
    * 만약 목적지 IP 주소가 한 링크로 연결되어 있다면 "연결됨" 으로 표시
5. 만약 공유형 링크라면, 다음 홉의 IP주소를 ARP를 통해 다음 홉의 MAC 주소를 알아냄