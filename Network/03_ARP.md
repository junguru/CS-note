# Address Resolution Protocol
## ARP 개념
* 네트워크 계층의 프로토콜로, 다음 홉의 IP주소를 통해 MAC 주소를 알아냄
* 공유형 링크의 경우, 매체를 여러 컴퓨터가 공유함
* 라우팅 테이블을 통해 얻은 다음 홉의 IP주소와 링크는 알 수 있지만, 해당 링크에 연결된 어떤 NIC에 전송해야 할지 알 수 없음

<br/>
<br/>

## ARP 작동 개요
1. 목적지 IP 주소를 라우팅 테이블에 검색해 다음 홉의 IP주소와 나가야 할 인터페이스 계산
2. 다음 홉의 IP 주소를 arp 캐시에 검색해 MAC 주소를 계산
* ARP는 공유형 링크를 사용하는 컴퓨터라면 모두 커널 내부에 구현되어 있음
* 만약 다음 홉의 IP주소에 해당하는 엔트리가 이미 arp 캐시에 있다면 arp 실행하지 않음
* 해당하는 엔트리가 arp 캐시에 없다면 arp가 작동해 엔트리를 채우고, 일정 시간이 지나면 삭제

<br/>
<br/>

## ARP Packet Format
|HW Type|Protocol Type|HW addr size|Protocol addr size|OP|snd HW addr|snd protocol addr|target HW addr|target protocol addr|
|--|--|--|--|--|--|--|--|--|
|데이터링크 프로토콜|네트워크 프로토콜|데이터링크 주소 크기|네트워크 주소 크기|요청/응답|전송 MAC주소|전송 네트워크 주소|타겟 MAC주소|타겟 네트워크 주소|

* ARP 패킷을 이더넷 등 데이터 링크 프레임의 페이로드에 실어 주고 받음
1. ARP 요청
    * 데이터 링크의 목적지를 Broadcast로 링크에 연결된 모든 인터페이스에 전송
    * 알고자 하는 타겟 MAC 주소는 모르는 상태이므로 0으로 채움
    * 자신의 IP 주소와 인터페이스의 MAC 주소를 채워서 ARP 패킷을 보냄
2. ARP 응답
    * 데이터 링크 계층 응답은 ARP 요청을 보낸 상대에게만 Unicast로 전송
    * ARP 패킷을 받은 응답자가 전송자의 (IP, MAC)을 ARP 캐시에 추가
    * 패킷을 받으면 높은 확률로 상대방에게 역방향 응답을 보내므로 응답자가 자신의 ARP 캐시에 추가하는 것은 효율적임

<br/>
<br/>

## ARP Cache Update Rule
1. ARP 요청이 내가 가진 인터페이스의 MAC 주소를 요청할 때
    * 상대방의 매핑 정보를 내 ARP 캐시에 추가
    * 내 정보 (IP, MAC)을 이더넷 프레임에 담아 unicast 전송
    * 내 ARP 패킷을 받은 요청자가 내 정보를 ARP 캐시에 추가
2. ARP 요청이 내가 아닌 공유 링크에 연결된 다른 노드를 향할 때
    * 요청자의 정보가 내 ARP 캐시에 있다면 (IP, MAC)을 갱신
    * 요청자의 정보가 내 ARP 캐시에 없다면 무시

<br/>
<br/>

## Special Cases
### Gratuitous ARP
* ARP 패킷에서 전송자 프로토콜 주소와 타겟 프로토콜 주소를 같게 설정한 패킷
* `DAD`(duplicate addr detection)
    * 정상적인 상황이라면 내 IP주소에 대한 ARP 요청은 아무도 응답하지 않아야 함
* IP, MAC 주소가 바뀐 경우 이를 링크에 연결된 컴퓨터들에게 공표할 경우
    1. NIC 교체 후 컴퓨터 리부트하는 등 MAC 주소가 변경될 경우
    2. 백업 서버가 IP주소를 그대로 사용하고 MAC 주소가 다른 경우
    3. 무선랜 인터페이스에서 다른 AP가 준 IP로 변경해 IP 주소가 변경될 경우

### Address Conflict Detection (ACD)
* Gratuitous ARP를 통한 DAD의 문제점
    * 만약 악의적인 호스트가 다른 호스트의 IP주소로 DAD 수행하는 경우
    * 잘못된 주소의 매핑이 링크에 연결된 호스트들의 ARP 캐시에 저장됨
    * 나에 대한 데이터 전송이 악의적인 호스트를 경유하게 됨
1. Probe
    * 전송자 프로토콜 주소를 0.0.0.0으로 설정해 ARP 캐시 오염시키지 않음
2. Announcement
    * 중복된 주소가 없음을 확인하고 자신의 (IP, MAC) 주소를 브로드캐스트

### ARP Cache 오염
* ACD 방법을 사용한다 하더라도, 악의적으로 매핑을 수정하는 것은 막을 수 없음
* 시스템이 모든 ARP 캐시 엔트리에 대해 주기적으로 ARP 요청을 보내 매핑이 정확한지 확인

### Proxy ARP
* 일부러 다른 IP 주소를 자신의 MAC 주소에 매핑해 ARP 응답을 하는 경우
* 모바일 IP 프로토콜에서 호스트가 다른 네트워크로 이동해도 home agent가 대신 받아 전달하기 위함

### Directed ARP
* ARP 요청을 브로드캐스트 대신 유니캐스트로 전송하는 경우
* ARP 캐시 엔트리의 유효 기간이 끝나 유효성을 확인하기 위해 유니캐스트로 요청